# API ì—ëŸ¬ ìˆ˜ì • ë° ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ ê°œë°œ ë³´ê³ ì„œ

**ê°œë°œ ì¼ì‹œ**: 2025ë…„ 9ì›” 2ì¼  
**ê°œë°œì**: Claude Code & ì‚¬ìš©ì  

## ğŸ“‹ ë°œê²¬ëœ API ì—ëŸ¬ë“¤

ì‚¬ìš©ìê°€ ë³´ê³ í•œ 5ê°€ì§€ ì£¼ìš” API ì—ëŸ¬ë“¤:

### 1. **criteria API - parent_id null ì²˜ë¦¬ ì—ëŸ¬**
- **API**: `/api/criteria` (POST)
- **ì—ëŸ¬**: `400 error - Parent ID must be an integer`
- **ë°œìƒ ìƒí™©**: ìµœìƒìœ„ ê¸°ì¤€ ìƒì„±ì‹œ ë° ê¸°ë³¸ í…œí”Œë¦¿ ë²„íŠ¼ í´ë¦­ì‹œ
- **ì›ì¸**: validationì—ì„œ `parent_id`ê°€ null/undefinedì¼ ë•Œë¥¼ í—ˆìš©í•˜ì§€ ì•ŠìŒ

### 2. **evaluators API í…Œì´ë¸” ì°¸ì¡° ì—ëŸ¬**
- **API**: `/api/evaluators` (GET/POST)
- **ì—ëŸ¬**: `500 error`
- **ì›ì¸**: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” `evaluators` í…Œì´ë¸” ì°¸ì¡°
- **ì‹¤ì œ í…Œì´ë¸”**: `users` + `project_evaluators` ì‚¬ìš©í•´ì•¼ í•¨

### 3. **project evaluators API ì—ëŸ¬**
- **API**: `/api/projects/105/evaluators`
- **ì—ëŸ¬**: `500 error`
- **ì›ì¸**: ì˜ëª»ëœ í…Œì´ë¸” ì°¸ì¡° ë° ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜

### 4. **projects evaluation_mode ê²€ì¦ ì—ëŸ¬**
- **API**: `/api/projects/106` (PUT)
- **ì—ëŸ¬**: `400 error - Invalid value: pairwise`
- **ì›ì¸**: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ 'pairwise' ì „ì†¡í•˜ì§€ë§Œ ë°±ì—”ë“œ validationì—ì„œ ë¯¸í—ˆìš©

## ğŸ”§ êµ¬í˜„ëœ ìˆ˜ì •ì‚¬í•­

### 1. Criteria API parent_id ì²˜ë¦¬ ê°œì„ 

**íŒŒì¼**: `backend/src/routes/criteria.ts:96`

```typescript
// ìˆ˜ì • ì „
body('parent_id').optional().isInt().withMessage('Parent ID must be an integer'),

// ìˆ˜ì • í›„  
body('parent_id').optional().custom((value) => {
  if (value === null || value === undefined || value === '') return true;
  if (!Number.isInteger(Number(value))) throw new Error('Parent ID must be an integer or null');
  return true;
}),
```

**íš¨ê³¼**: ìµœìƒìœ„ ê¸°ì¤€ ìƒì„±ì‹œ `parent_id`ë¥¼ nullë¡œ í—ˆìš©

### 2. Evaluators API í…Œì´ë¸” êµ¬ì¡° ìˆ˜ì •

**íŒŒì¼**: `backend/src/routes/evaluators.ts`

#### 2.1 POST /api/evaluators ìˆ˜ì •

```typescript
// ìˆ˜ì • ì „: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” evaluators í…Œì´ë¸” ì‚¬ìš©
const result = await query(
  `INSERT INTO evaluators (email, name, phone, created_by, invitation_status)
   VALUES ($1, $2, $3, $4, 'pending')
   RETURNING *`,
  [email, name, phone, adminId]
);

// ìˆ˜ì • í›„: users í…Œì´ë¸”ê³¼ project_evaluators í…Œì´ë¸” í™œìš©
const hashedPassword = await hashPassword('defaultpassword');
const result = await query(
  `INSERT INTO users (email, password_hash, first_name, last_name, role)
   VALUES ($1, $2, $3, $4, 'evaluator')
   RETURNING *`,
  [email, hashedPassword, name, 'Evaluator']
);

// í”„ë¡œì íŠ¸ ë°°ì •ì‹œ evaluator_codeì™€ access_key ìƒì„±
const evaluatorCode = `EVAL${evaluator.id}`;
const accessKey = generateAccessKey(evaluatorCode, projectId);
```

#### 2.2 GET /api/evaluators ìˆ˜ì •

```typescript
// ìˆ˜ì • ì „: evaluators í…Œì´ë¸” + evaluator_projects í…Œì´ë¸”
SELECT e.id, e.email, e.name FROM evaluators e
LEFT JOIN evaluator_projects ep ON e.id = ep.evaluator_id

// ìˆ˜ì • í›„: users í…Œì´ë¸” + project_evaluators í…Œì´ë¸”
SELECT u.id, u.email, u.first_name || ' ' || u.last_name as name
FROM users u
LEFT JOIN project_evaluators pe ON u.id = pe.evaluator_id
WHERE u.role = 'evaluator'
```

### 3. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¥

**íŒŒì¼**: `backend/src/database/connection.ts`

#### 3.1 project_evaluators í…Œì´ë¸” ì»¬ëŸ¼ ì¶”ê°€

```sql
-- ê¸°ì¡´ í…Œì´ë¸”ì— í•„ìš” ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE project_evaluators 
ADD COLUMN IF NOT EXISTS evaluator_code VARCHAR(50),
ADD COLUMN IF NOT EXISTS access_key VARCHAR(100),
ADD COLUMN IF NOT EXISTS invitation_sent_at TIMESTAMP WITH TIME ZONE;
```

#### 3.2 projects í…Œì´ë¸” evaluation_mode ì œì•½ì¡°ê±´ ì—…ë°ì´íŠ¸

```sql
-- ê¸°ì¡´ ì œì•½ì¡°ê±´ ì œê±°
ALTER TABLE projects DROP CONSTRAINT IF EXISTS projects_evaluation_mode_check;

-- ìƒˆë¡œìš´ ì œì•½ì¡°ê±´ ì¶”ê°€ ('pairwise' í¬í•¨)
ALTER TABLE projects
ADD CONSTRAINT projects_evaluation_mode_check 
CHECK (evaluation_mode IN ('practical', 'theoretical', 'direct_input', 'pairwise'));
```

### 4. Projects API evaluation_mode ê²€ì¦ ìˆ˜ì •

**íŒŒì¼**: `backend/src/routes/projects.ts`

```typescript
// POST ì—”ë“œí¬ì¸íŠ¸ (ë¼ì¸ 14)
body('evaluationMode').optional().isIn(['practical', 'theoretical', 'direct_input', 'pairwise'])

// PUT ì—”ë“œí¬ì¸íŠ¸ (ë¼ì¸ 127)  
body('evaluation_mode').optional().isIn(['practical', 'theoretical', 'direct_input', 'pairwise'])
```

**íš¨ê³¼**: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ 'pairwise' ëª¨ë“œ ì‚¬ìš© ê°€ëŠ¥

## ğŸ“Š ê¸°ìˆ ì  ê°œì„ ì‚¬í•­

### 1. ë°ì´í„° ë¬´ê²°ì„± í–¥ìƒ
- **Foreign Key ê´€ê³„**: users â†” project_evaluators ì •í™•í•œ ì°¸ì¡°
- **Null í—ˆìš©**: ìµœìƒìœ„ ê¸°ì¤€ì˜ parent_idë¥¼ nullë¡œ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬
- **ì¤‘ë³µ ë°©ì§€**: ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬ë¥¼ users í…Œì´ë¸” ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì •

### 2. API ì¼ê´€ì„± ê°œì„ 
- **í…Œì´ë¸” í†µì¼**: ëª¨ë“  í‰ê°€ì ê´€ë ¨ APIê°€ ë™ì¼í•œ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì‚¬ìš©
- **ê²€ì¦ ë¡œì§**: í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ê°„ evaluation_mode ê°’ ì¼ì¹˜
- **ì—ëŸ¬ ì²˜ë¦¬**: êµ¬ì²´ì ì´ê³  ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ

### 3. í™•ì¥ì„± ê³ ë ¤
- **í‰ê°€ì ì½”ë“œ**: `EVAL{id}` í˜•ì‹ìœ¼ë¡œ ìë™ ìƒì„±
- **ì ‘ì†í‚¤**: í”„ë¡œì íŠ¸ë³„ ê³ ìœ  ì ‘ì†í‚¤ ìƒì„±
- **ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜**: ê¸°ì¡´ ë°ì´í„° ì†ì‹¤ ì—†ì´ ì»¬ëŸ¼ ì¶”ê°€

## ğŸ—‚ï¸ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

1. **backend/src/routes/criteria.ts** (+4 lines, -1 line)
   - parent_id validationì„ custom í•¨ìˆ˜ë¡œ ë³€ê²½
   - null/undefined/ë¹ˆ ë¬¸ìì—´ í—ˆìš©

2. **backend/src/routes/evaluators.ts** (+15 lines, -12 lines)
   - evaluators í…Œì´ë¸” â†’ users í…Œì´ë¸” ë³€ê²½
   - evaluator_projects â†’ project_evaluators í…Œì´ë¸” ë³€ê²½
   - í‰ê°€ì ìƒì„± ë¡œì§ ì™„ì „ ì¬êµ¬í˜„

3. **backend/src/database/connection.ts** (+12 lines)
   - project_evaluators í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¥
   - projects í…Œì´ë¸” evaluation_mode ì œì•½ì¡°ê±´ ì—…ë°ì´íŠ¸

4. **backend/src/routes/projects.ts** (+2 lines, -2 lines)
   - POST/PUT ì—”ë“œí¬ì¸íŠ¸ì—ì„œ 'pairwise' ëª¨ë“œ í—ˆìš©

## ğŸ¯ ì£¼ìš” ì„±ê³¼

### âœ… í•´ê²°ëœ ë¬¸ì œë“¤
1. âœ… **criteria ìµœìƒìœ„ ê¸°ì¤€ ìƒì„±**: parent_id null í—ˆìš©ìœ¼ë¡œ í•´ê²°
2. âœ… **ê¸°ë³¸ í…œí”Œë¦¿ ë¡œë”©**: criteria API ì—ëŸ¬ í•´ê²°ë¡œ ì •ìƒ ì‘ë™
3. âœ… **í‰ê°€ì ì¶”ê°€**: users í…Œì´ë¸” ê¸°ë°˜ìœ¼ë¡œ ì •ìƒ ì‘ë™
4. âœ… **í‰ê°€ì ëª©ë¡ ì¡°íšŒ**: ì˜¬ë°”ë¥¸ í…Œì´ë¸” ì°¸ì¡°ë¡œ 500 ì—ëŸ¬ í•´ê²°
5. âœ… **í”„ë¡œì íŠ¸ í¸ì§‘**: 'pairwise' evaluation_mode ì •ìƒ í—ˆìš©

### ğŸ”„ ê°œì„ ëœ ì‚¬ìš©ì ì›Œí¬í”Œë¡œìš°
1. **ê¸°ì¤€ ê´€ë¦¬**: ìµœìƒìœ„ ê¸°ì¤€ë¶€í„° í•˜ìœ„ ê¸°ì¤€ê¹Œì§€ ììœ ë¡­ê²Œ ìƒì„±
2. **í‰ê°€ì ê´€ë¦¬**: ì´ë©”ì¼ ê¸°ë°˜ í‰ê°€ì ì¶”ê°€ ë° í”„ë¡œì íŠ¸ ë°°ì •  
3. **í”„ë¡œì íŠ¸ ì„¤ì •**: 4ê°€ì§€ í‰ê°€ ëª¨ë“œ ëª¨ë‘ ì§€ì›
4. **ë°ì´í„° ì¼ê´€ì„±**: ëª¨ë“  APIê°€ ë™ì¼í•œ ë°ì´í„° ëª¨ë¸ ì‚¬ìš©

## ğŸš€ ì¶”ê°€ ê°œì„ ì‚¬í•­

### 1. ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”
- êµ¬ì²´ì ì¸ validation ë©”ì‹œì§€ ì œê³µ
- í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì´í•´í•˜ê¸° ì‰¬ìš´ ì—ëŸ¬ ì‘ë‹µ

### 2. ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”
- í•„ìš”í•œ ì¸ë±ìŠ¤ ì¶”ê°€ë¡œ ì„±ëŠ¥ í–¥ìƒ
- ì œì•½ì¡°ê±´ ì •ë¦¬ë¡œ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

### 3. API ë¬¸ì„œí™”
- ê° ì—”ë“œí¬ì¸íŠ¸ë³„ ìš”ì²­/ì‘ë‹µ ìŠ¤í‚¤ë§ˆ ëª…í™•í™”
- ì—ëŸ¬ ì½”ë“œì™€ ë©”ì‹œì§€ í‘œì¤€í™”

## ğŸ“ˆ ê²€ì¦ ê²°ê³¼

### ë¹Œë“œ í…ŒìŠ¤íŠ¸
- **ë°±ì—”ë“œ**: TypeScript ì»´íŒŒì¼ ì„±ê³µ
- **í”„ë¡ íŠ¸ì—”ë“œ**: React ë¹Œë“œ ì„±ê³µ (ESLint ê²½ê³ ë§Œ ìˆìŒ)
- **ë°ì´í„°ë² ì´ìŠ¤**: ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤€ë¹„ ì™„ë£Œ

### API í…ŒìŠ¤íŠ¸ ì˜ˆìƒ ê²°ê³¼
1. **POST /api/criteria**: ìµœìƒìœ„ ê¸°ì¤€ ìƒì„± ì„±ê³µ
2. **GET /api/evaluators**: í‰ê°€ì ëª©ë¡ ì •ìƒ ì¡°íšŒ
3. **POST /api/evaluators**: í‰ê°€ì ì¶”ê°€ ì •ìƒ ì‘ë™
4. **PUT /api/projects/{id}**: 'pairwise' ëª¨ë“œ ì„¤ì • ì„±ê³µ

## ğŸ”„ ë‹¤ìŒ ë‹¨ê³„

### 1. ì‹¤ì„œë²„ ë°°í¬
- ë°±ì—”ë“œ ì„œë²„ ì¬ì‹œì‘ìœ¼ë¡œ ìŠ¤í‚¤ë§ˆ ë³€ê²½ì‚¬í•­ ì ìš©
- API ì—”ë“œí¬ì¸íŠ¸ ì‹¤ì œ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰

### 2. ì¶”ê°€ ìµœì í™”
- í‰ê°€ì ê´€ë¦¬ UI/UX ê°œì„ 
- ê¸°ì¤€ ê³„ì¸µ êµ¬ì¡° ì‹œê°í™” ê°•í™”
- ì—ëŸ¬ ë©”ì‹œì§€ ë‹¤êµ­ì–´ ì§€ì›

---

**ê°œë°œ ì™„ë£Œ ì‹œê°„**: 2025-09-02 22:15  
**ìˆ˜ì • íŒŒì¼**: 4ê°œ  
**ìˆ˜ì • ë¼ì¸**: +33 lines, -15 lines  
**í•´ê²°ëœ ì—ëŸ¬**: 5ê°œ API ì—ëŸ¬