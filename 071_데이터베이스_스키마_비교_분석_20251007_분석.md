# 데이터베이스 스키마 비교 분석

## 일시
- **일시**: 2025년 8월 17일 09:00:00

## 📊 요구사항 vs 현재 구현 비교

### ✅ 잘 적용된 부분

| 요구 테이블 | 현재 구현 | 적용도 | 상세 |
|------------|----------|--------|------|
| **project** | **projects** | 95% | ✅ 기본 구조 동일, status 체크 제약 추가 |
| **criterion** | **criteria** | 85% | ✅ 계층구조 지원, level 제약 (최대 4레벨) |
| **alternative** | **alternatives** | 90% | ✅ 기본 구조 완전 구현 |
| **pairwise_entry** | **pairwise_comparisons** | 80% | ✅ 쌍대비교 저장, 타입 구분 추가 |
| **weight_result** | **results** | 70% | ✅ 가중치 저장, 일관성 비율 추가 |

### ⚠️ 부분 적용 또는 차이점

#### 1. **평가자(Rater) 관리**
**요구사항:**
```sql
CREATE TABLE rater (
  id SERIAL PRIMARY KEY,
  project_id INT REFERENCES project(id) ON DELETE CASCADE,
  code VARCHAR(50) UNIQUE,  -- p001 등
  name VARCHAR(100)
);
```

**현재 구현:**
```sql
-- users 테이블로 통합하고 project_evaluators로 연결
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  role VARCHAR(20) NOT NULL CHECK (role IN ('admin', 'evaluator'))
);

CREATE TABLE project_evaluators (
  project_id INTEGER NOT NULL REFERENCES projects(id),
  evaluator_id INTEGER NOT NULL REFERENCES users(id)
);
```

**분석:** 
- ✅ **장점**: 전역 사용자 관리, 재사용 가능
- ⚠️ **단점**: 프로젝트별 평가자 코드(p001) 없음

#### 2. **평가 방법 지원**
**요구사항:**
```sql
-- criterion 테이블에 eval_method 컬럼
eval_method VARCHAR(20) NOT NULL DEFAULT 'pairwise' -- pairwise|direct
```

**현재 구현:**
```sql
-- criteria 테이블에 eval_method 없음
CREATE TABLE criteria (
  -- eval_method 컬럼 누락
);
```

**분석:**
- ❌ **누락**: 평가방법 선택 기능 없음
- 📝 **영향**: 직접입력 vs 쌍대비교 구분 불가

#### 3. **직접입력 데이터**
**요구사항:**
```sql
CREATE TABLE direct_entry (
  target_key VARCHAR(100) NOT NULL, -- 'criterion:ID' or 'alternative:ID@criterion:ID'
  value NUMERIC(18,6) NOT NULL,
  is_benefit BOOLEAN NOT NULL DEFAULT TRUE -- 비용형이면 FALSE
);
```

**현재 구현:**
- ❌ **미구현**: direct_entry 테이블 없음
- 📝 **영향**: 정량 데이터 직접 입력 불가

#### 4. **진행 상황 관리**
**요구사항:**
```sql
CREATE TABLE rater_progress (
  is_completed BOOLEAN DEFAULT FALSE,
  completed_at TIMESTAMP
);
```

**현재 구현:**
- ❌ **미구현**: 평가 진행 상황 추적 없음
- 📝 **영향**: 평가자별 완료율 확인 불가

#### 5. **그룹 가중치**
**요구사항:**
```sql
CREATE TABLE rater_group_weight (
  rater_id INT REFERENCES rater(id),
  weight NUMERIC(10,6) NOT NULL DEFAULT 1.0
);
```

**현재 구현:**
- ❌ **미구현**: 평가자별 가중치 없음
- 📝 **영향**: 평가자 중요도 차등 적용 불가

### 🔄 개선 사항 및 추가 구현 필요

#### 1. **즉시 추가 필요한 테이블/컬럼**

```sql
-- 1. criteria 테이블에 eval_method 추가
ALTER TABLE criteria ADD COLUMN eval_method VARCHAR(20) NOT NULL DEFAULT 'pairwise';
ALTER TABLE criteria ADD CONSTRAINT check_eval_method CHECK (eval_method IN ('pairwise', 'direct'));

-- 2. 직접입력 테이블 추가
CREATE TABLE direct_entries (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    evaluator_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    target_key VARCHAR(100) NOT NULL, -- 'criterion:ID' or 'alternative:ID@criterion:ID'
    value NUMERIC(18,6) NOT NULL,
    is_benefit BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_direct_entry UNIQUE (project_id, evaluator_id, target_key)
);

-- 3. 진행 상황 관리 테이블 추가
CREATE TABLE evaluator_progress (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    evaluator_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    is_completed BOOLEAN DEFAULT FALSE,
    completed_at TIMESTAMP WITH TIME ZONE,
    completion_rate DECIMAL(5,2) DEFAULT 0.0, -- 0-100%
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_evaluator_progress UNIQUE (project_id, evaluator_id)
);

-- 4. 평가자 그룹 가중치 테이블 추가
CREATE TABLE evaluator_weights (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    evaluator_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    weight NUMERIC(10,6) NOT NULL DEFAULT 1.0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_evaluator_weight UNIQUE (project_id, evaluator_id),
    CONSTRAINT positive_weight CHECK (weight > 0)
);

-- 5. 평가자 코드 지원을 위한 컬럼 추가
ALTER TABLE project_evaluators ADD COLUMN evaluator_code VARCHAR(50);
ALTER TABLE project_evaluators ADD CONSTRAINT unique_evaluator_code_per_project 
    UNIQUE (project_id, evaluator_code);
```

#### 2. **매트릭스 키 개선**

**요구사항의 matrix_key 개념:**
- `"C:criterionId"` - 기준 간 비교
- `"A:criterionId"` - 특정 기준 하의 대안 간 비교

**현재 구현 개선안:**
```sql
-- pairwise_comparisons 테이블에 matrix_key 컬럼 추가
ALTER TABLE pairwise_comparisons ADD COLUMN matrix_key VARCHAR(100);
ALTER TABLE pairwise_comparisons ADD COLUMN i_index INTEGER;
ALTER TABLE pairwise_comparisons ADD COLUMN j_index INTEGER;

-- 기존 UNIQUE 제약 대신 새로운 제약 추가
ALTER TABLE pairwise_comparisons DROP CONSTRAINT unique_comparison;
ALTER TABLE pairwise_comparisons ADD CONSTRAINT unique_matrix_comparison 
    UNIQUE (project_id, evaluator_id, matrix_key, i_index, j_index);
```

## 📈 구현 적합도 평가

### 전체 데이터베이스 적합도: **75%**

| 영역 | 적합도 | 상태 |
|------|--------|------|
| **핵심 엔티티** | 95% | ✅ 우수 |
| **관계 설계** | 90% | ✅ 우수 |
| **계층구조** | 85% | ✅ 좋음 |
| **쌍대비교** | 80% | 🔄 개선 필요 |
| **직접입력** | 0% | ❌ 미구현 |
| **진행관리** | 0% | ❌ 미구현 |
| **그룹가중치** | 0% | ❌ 미구현 |
| **성능최적화** | 95% | ✅ 우수 |

### ✅ 잘 구현된 부분
1. **기본 구조**: 프로젝트, 기준, 대안 테이블 완벽
2. **계층 지원**: 4레벨 제한, 자체 참조 관계
3. **데이터 무결성**: 외래키, 제약조건, 트리거
4. **성능**: 적절한 인덱스 설계
5. **확장성**: 타임스탬프, 소프트 삭제 가능

### ⚠️ 중요한 누락 사항
1. **평가 방법 구분**: pairwise vs direct
2. **직접 입력 지원**: 정량 데이터 처리
3. **진행 상황 추적**: 완료율, 상태 관리
4. **평가자 가중치**: 그룹 의사결정 지원
5. **매트릭스 식별**: matrix_key 개념

## 🚀 다음 단계 권장사항

### Phase 1: 즉시 구현 (높은 우선순위)
1. **eval_method 컬럼 추가** - criteria 테이블
2. **direct_entries 테이블 생성** - 직접입력 지원
3. **evaluator_progress 테이블** - 진행상황 추적

### Phase 2: 단기 구현 (중간 우선순위)
1. **evaluator_weights 테이블** - 그룹 가중치
2. **matrix_key 개선** - 쌍대비교 매트릭스 식별
3. **평가자 코드** - 프로젝트별 식별자

### Phase 3: 장기 개선 (낮은 우선순위)
1. **감사 로그** - 변경 이력 추적
2. **성능 최적화** - 파티셔닝, 캐싱
3. **백업/복구** - 데이터 보호

현재 데이터베이스 설계는 **전반적으로 우수하며**, 핵심 AHP 기능을 지원하기에 충분합니다. 다만 **직접입력, 진행관리, 그룹가중치** 기능을 위한 추가 테이블이 필요합니다.