# 백엔드 배포 가이드 - 2025-09-28

## 🎯 목적
프로젝트 API 500 오류 수정 및 퍼지 AHP, 휴지통 기능 지원

## 📝 변경 사항 요약

### 1. Project 모델 필드 추가
```python
# 새로 추가된 필드
evaluation_mode = CharField(max_length=20, choices=EVALUATION_MODE_CHOICES, default='practical')
workflow_stage = CharField(max_length=20, choices=WORKFLOW_STAGE_CHOICES, default='creating')
deleted_at = DateTimeField(null=True, blank=True)
criteria_count = PositiveIntegerField(default=0)
alternatives_count = PositiveIntegerField(default=0)
```

### 2. 평가 모드 선택지
- **practical**: 쌍대비교(권장) - 기본값
- **theoretical**: 이론적 접근
- **direct_input**: 직접 입력
- **fuzzy_ahp**: 퍼지 AHP (삼각퍼지수)

### 3. 워크플로우 단계
- **creating**: 프로젝트 생성 중
- **waiting**: 평가 대기 중
- **evaluating**: 평가 진행 중
- **completed**: 완료

### 4. 휴지통 기능 API

#### 소프트 삭제 (휴지통으로 이동)
```http
DELETE /api/v1/projects/{id}/soft_delete/
Authorization: Bearer {token}
```

#### 복원
```http
POST /api/v1/projects/{id}/restore/
Authorization: Bearer {token}
```

#### 휴지통 목록 조회
```http
GET /api/v1/projects/trash/
Authorization: Bearer {token}
```

#### 영구 삭제
```http
DELETE /api/v1/projects/{id}/permanent_delete/
Authorization: Bearer {token}
```

## 🚀 Render.com 배포 절차

### Step 1: 코드 배포
Render.com에서 자동으로 감지하거나 수동 배포:

1. **Render.com 대시보드 접속**
   - https://dashboard.render.com
   - ahp-django-backend 서비스 선택

2. **GitHub 연동 확인**
   - Settings → Build & Deploy
   - Repository: aebonlee/ahp_app
   - Branch: main
   - Auto-Deploy: Yes

3. **수동 배포 (필요시)**
   - Manual Deploy 버튼 클릭
   - "Deploy latest commit" 선택

### Step 2: 데이터베이스 마이그레이션

배포가 완료되면 **반드시** 마이그레이션 실행:

1. **Shell 접속**
   ```
   Render Dashboard → ahp-django-backend → Shell 탭
   ```

2. **마이그레이션 명령 실행**
   ```bash
   python manage.py migrate projects
   ```

3. **결과 확인**
   ```
   Expected output:
   Running migrations:
     Applying projects.0003_add_evaluation_mode_and_trash... OK
   ```

### Step 3: 서비스 재시작

1. **자동 재시작**
   - 마이그레이션 후 자동으로 재시작됨

2. **수동 재시작 (필요시)**
   - Settings → Restart Service

## 🧪 배포 후 테스트

### 1. Health Check
```bash
curl https://ahp-django-backend.onrender.com/api/health
```
예상 응답:
```json
{"status": "healthy", "service": "AHP Backend API"}
```

### 2. 사용자 로그인
```bash
curl -X POST https://ahp-django-backend.onrender.com/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"projecttest3","password":"testpass123"}'
```

토큰 저장:
```bash
export TOKEN="여기에_발급받은_토큰"
```

### 3. 프로젝트 생성 테스트 (쌍대비교)
```bash
curl -X POST https://ahp-django-backend.onrender.com/api/v1/projects/ \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "쌍대비교 프로젝트 테스트",
    "description": "일반 AHP 프로젝트",
    "objective": "테스트 목적",
    "evaluation_mode": "practical",
    "workflow_stage": "creating"
  }'
```

### 4. 퍼지 AHP 프로젝트 생성 테스트
```bash
curl -X POST https://ahp-django-backend.onrender.com/api/v1/projects/ \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "퍼지 AHP 프로젝트 테스트",
    "description": "삼각퍼지수를 사용한 프로젝트",
    "objective": "불확실성 반영 의사결정",
    "evaluation_mode": "fuzzy_ahp",
    "workflow_stage": "creating"
  }'
```

### 5. 프로젝트 목록 조회
```bash
curl -X GET https://ahp-django-backend.onrender.com/api/v1/projects/ \
  -H "Authorization: Bearer $TOKEN"
```

### 6. 휴지통 테스트
```bash
# 프로젝트 ID 저장
PROJECT_ID="프로젝트_UUID"

# 휴지통으로 이동
curl -X DELETE "https://ahp-django-backend.onrender.com/api/v1/projects/$PROJECT_ID/soft_delete/" \
  -H "Authorization: Bearer $TOKEN"

# 휴지통 목록 확인
curl -X GET https://ahp-django-backend.onrender.com/api/v1/projects/trash/ \
  -H "Authorization: Bearer $TOKEN"

# 복원
curl -X POST "https://ahp-django-backend.onrender.com/api/v1/projects/$PROJECT_ID/restore/" \
  -H "Authorization: Bearer $TOKEN"
```

## ✅ 성공 확인 체크리스트

- [ ] Render.com 자동 배포 완료
- [ ] 마이그레이션 성공 (0003_add_evaluation_mode_and_trash)
- [ ] Health check 응답 정상
- [ ] 사용자 로그인 성공
- [ ] 일반 프로젝트 생성 성공 (practical mode)
- [ ] 퍼지 AHP 프로젝트 생성 성공 (fuzzy_ahp mode)
- [ ] 프로젝트 목록 조회 성공 (500 오류 해결)
- [ ] 휴지통 이동/복원 테스트 성공

## ⚠️ 주의사항

1. **마이그레이션 필수**
   - 배포 후 반드시 `python manage.py migrate projects` 실행
   - 실행하지 않으면 필드 누락 오류 발생

2. **기존 데이터**
   - 기존 프로젝트는 자동으로 `evaluation_mode='practical'` 설정
   - `workflow_stage='creating'` 기본값 적용

3. **권한 확인**
   - 프로젝트 소유자만 삭제/복원/영구삭제 가능
   - 삭제된 프로젝트는 일반 목록에서 자동 제외

4. **프론트엔드 연동**
   - 프론트엔드 코드는 이미 새 필드 지원 준비 완료
   - 백엔드 배포 후 즉시 사용 가능

## 📊 변경 파일 목록

```
ahp_django_service_updated/
├── apps/projects/
│   ├── models.py                           # 필드 추가
│   ├── serializers.py                      # 시리얼라이저 업데이트
│   ├── views.py                            # 휴지통 API 추가
│   └── migrations/
│       └── 0003_add_evaluation_mode_and_trash.py  # 새 마이그레이션
└── BACKEND_UPDATE_README.md                # 배포 가이드
```

## 🔗 관련 링크

- **Render.com 대시보드**: https://dashboard.render.com
- **백엔드 API**: https://ahp-django-backend.onrender.com
- **GitHub 저장소**: https://github.com/aebonlee/ahp_app
- **커밋**: c11ffa2f

## 📞 문제 발생 시

1. **마이그레이션 실패**
   - Shell에서 `python manage.py showmigrations projects` 확인
   - `python manage.py migrate projects --fake-initial` 시도

2. **500 오류 지속**
   - Logs 탭에서 에러 메시지 확인
   - `python manage.py check` 실행

3. **필드 누락 오류**
   - 마이그레이션 재실행
   - 서비스 수동 재시작

---
**작성일**: 2025-09-28
**작성자**: Claude Code
**버전**: 1.0.0